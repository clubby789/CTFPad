<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>
    <script src="/static/javascript/diff_match_patch.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
  </head>
  <body>
    <form id="the_form">
      <textarea name="msg" id="msgdoc" rows="30" cols="50"></textarea>
      <input type="submit" value="Send">
    </form>
    <script>
      var socket = io('http://localhost:8080/chat');
      var latest;
      var timer;
      let interval = 100;
      var shadow;
      var editor = new SimpleMDE({ element: document.getElementById("msgdoc") });
      editor.codemirror.on('keyup', function() {
        clearTimeout(timer);
        timer = setTimeout(emit_patch, interval);
      });

      editor.codemirror.on('keydown', function() {
        clearTimeout(timer);
      });

      let dmp = new diff_match_patch();
      
      socket.on('connect', function(){console.log('connect!')});
      socket.on('message', function(msg){console.log('message: ' + msg)});
      socket.on('disconnect', function(){console.log('disconnect!')});
      socket.on('dump', function(contents) {
        editor.value(contents);
        shadow = contents;
      });
      socket.on('patch', function(patch){
        var patchOb = dmp.patch_fromText(patch);
        var oldpos = editor.codemirror.indexFromPos(editor.codemirror.getCursor());
        var newpos = oldpos; // Hold new offset
        var processed = 0; // Hold number of chars iterated through in the patches
        for (var i=0; i < patchOb.length; i++) {
          newpos += patchOb[i].length2 - patchOb[i].length1;
          processed += patchOb[i].length1;
          if (processed > oldpos) {
            break;
          }
        }
        res = dmp.patch_apply(patchOb, editor.value());
        editor.value(res[0]);
        res = dmp.patch_apply(patchOb, shadow);
        shadow = res[0];
        editor.codemirror.setCursor(editor.codemirror.posFromIndex(newpos));
      });

      function emit_patch(patch) {
        var diff = dmp.patch_make(shadow, editor.value());
        var patch = dmp.patch_toText(diff);
        shadow = editor.value();
        socket.emit('chat message', patch);
      }
    </script>
  </body>
</html>
